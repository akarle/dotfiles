#!/usr/bin/env bash
# Originally inspired by https://github.com/mathiasbynens/dotfiles/
# but since trimmed down / modified for my own purposes
if [ -n "$SSH_CLIENT" ]; then
    ssh_text="[$USER@$(hostname)] "
fi

function parse_git_dirty() {
    if [ -z "$BASH_PROMPT_NO_GSTATUS" ]; then
        [ "$(git status --porcelain=v1 2> /dev/null)" ] && echo "*"
    fi
}

function parse_git_branch() {
    git branch --no-color 2> /dev/null | sed -e '/^[^*]/d' -e "s/* \(.*\)/\1$(parse_git_dirty)/"
}

function get_error_code() {
    err="$?"
    if [ $err -ne "0" ]; then
        echo "[$err] "
    fi
}

# Preferred Prompt: Fancy with colors from tput
if tput setaf 1 &> /dev/null; then tput sgr0
    if [[ $(tput colors) -ge 8 ]] 2>/dev/null; then
        SET_PREFERRED_PROMPT=1
        RED="\[$(tput setaf 1)\]"
        MAGENTA="\[$(tput setaf 5)\]"
        YELLOW="\[$(tput setaf 3)\]"
        GRAY="\[$(tput setaf 8)\]"
        BLUE="\[$(tput setaf 4)\]"
        BOLD="\[$(tput bold)\]"
        RESET="\[$(tput sgr0)\]"

        export PS1="$BOLD$RED\$(get_error_code)$BLUE\w $RESET$GRAY${ssh_text}\$(parse_git_branch)"$'\n'"$BOLD$MAGENTA\$ $RESET"
        export PS2="$YELLOW> $RESET"
    fi
fi

# Fallback Option: No colors, No Git
if [ -z $SET_PREFERRED_PROMPT ]; then
    export PS1="\w\n${ssh_text}\$ "
    export PS2="> "
fi
